<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Contact Shelter - PetPaw</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link rel="stylesheet" href="/static/css/style.css"/>
  <style>
    .message-bubble {
      max-width: 75%;
      border-radius: 18px;
      padding: 10px 16px;
      margin-bottom: 8px;
      word-wrap: break-word;
    }
    .message-sent {
      background-color: #198754;
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    .message-received {
      background-color: #f0f0f0;
      color: #333;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }
    .chat-box {
      height: 420px;
      overflow-y: auto;
      background: #fafafa;
      border-radius: 16px;
      padding: 20px;
      border: 1px solid #e0e0e0;
    }
    .shelter-card { border-left: 4px solid #198754; }
  </style>
</head>
<body class="bg-light">

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold text-success" href="/static/index.html">
        <i class="fas fa-paw me-2"></i>PetPaw
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="/static/index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="/static/shelters.html">Shelters</a></li>
          <li class="nav-item"><a class="nav-link" href="/static/donate.html">Donate</a></li>
          <li class="nav-item"><a class="nav-link" href="/static/my-adoptions.html">My Adoptions</a></li>
          <li class="nav-item"><a class="nav-link" href="/static/login.html">Login</a></li>
          <li class="nav-item">
            <a class="nav-link btn btn-success text-white ms-3 px-4" href="/static/register.html">Register</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <section class="bg-success text-white text-center py-4">
    <div class="container">
      <h2 class="fw-bold mb-1"><i class="fas fa-envelope me-2"></i>Contact a Shelter</h2>
      <p class="mb-0">Send a message directly to your chosen shelter</p>
    </div>
  </section>

  <div class="container py-5">

    <!-- Not logged in -->
    <div id="notLoggedIn" style="display:none;">
      <div class="text-center py-5">
        <i class="fas fa-lock text-muted" style="font-size:4rem;"></i>
        <h4 class="mt-3 fw-bold">Please Login First</h4>
        <p class="text-muted">You need to be logged in to contact a shelter.</p>
        <a href="/static/login.html" class="btn btn-success px-4">Login Now</a>
      </div>
    </div>

    <!-- Main content -->
    <div id="mainContent" style="display:none;">
      <div class="row g-4">

        <!-- Left: Shelter selector + info -->
        <div class="col-lg-4">

          <!-- Select Shelter -->
          <div class="card border-0 shadow-sm rounded-4 p-4 mb-4">
            <h6 class="fw-bold mb-3"><i class="fas fa-home text-success me-2"></i>Select Shelter</h6>
            <select class="form-select" id="shelterSelect" onchange="onShelterChange()">
              <option value="">-- Choose a shelter --</option>
            </select>
          </div>

          <!-- Shelter Info Card -->
          <div class="card border-0 shadow-sm rounded-4 p-4 shelter-card" id="shelterInfoCard" style="display:none;">
            <div class="text-center mb-3">
              <img id="shelterLogo" src="" style="width:70px;height:70px;object-fit:cover;border-radius:50%;">
            </div>
            <h6 class="fw-bold mb-1" id="shelterName"></h6>
            <p class="text-muted small mb-1"><i class="fas fa-map-marker-alt text-success me-1"></i><span id="shelterAddress"></span></p>
            <p class="text-muted small mb-1"><i class="fas fa-phone text-success me-1"></i><span id="shelterPhone"></span></p>
            <p class="text-muted small mb-0"><i class="fas fa-envelope text-success me-1"></i><span id="shelterEmail"></span></p>
          </div>

        </div>

        <!-- Right: Chat -->
        <div class="col-lg-8">
          <div class="card border-0 shadow-sm rounded-4 p-4">
            <h6 class="fw-bold mb-3"><i class="fas fa-comments text-success me-2"></i>Messages</h6>

            <!-- Chat box -->
            <div class="chat-box mb-3" id="chatBox">
              <div class="text-center text-muted py-5" id="chatPlaceholder">
                <i class="fas fa-comments" style="font-size:3rem;opacity:0.3;"></i>
                <p class="mt-2">Select a shelter to start messaging</p>
              </div>
            </div>

            <!-- Message input -->
            <div class="d-flex gap-2" id="messageInputArea" style="display:none !important;">
              <input type="text" class="form-control rounded-pill" id="messageInput"
                     placeholder="Type your message..." onkeypress="handleEnter(event)">
              <button class="btn btn-success rounded-pill px-4" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>

            <div id="messageResult" class="mt-2"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-dark text-white text-center py-4 mt-4">
    <p>¬© 2026 PetPaw - Made with ‚ù§Ô∏è for animals</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/js/main.js"></script>
  <script>
    let selectedShelterId = null;
    let sheltersData = [];
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', async () => {
      currentUser = getCurrentUser();

      if (!currentUser) {
        document.getElementById('notLoggedIn').style.display = 'block';
        return;
      }

      document.getElementById('mainContent').style.display = 'block';

      // Check if shelter_id is in URL (coming from shelter detail page)
      const params = new URLSearchParams(window.location.search);
      const preSelectedId = params.get('shelter_id');

      await loadShelterOptions(preSelectedId);
    });

    async function loadShelterOptions(preSelectedId = null) {
      try {
        const res = await fetch('/api/shelters');
        const data = await res.json();
        sheltersData = data.shelters || [];

        const select = document.getElementById('shelterSelect');
        select.innerHTML = '<option value="">-- Choose a shelter --</option>';
        sheltersData.forEach(s => {
          select.innerHTML += `<option value="${s.id}">${s.name}</option>`;
        });

        if (preSelectedId) {
          select.value = preSelectedId;
          onShelterChange();
        }
      } catch (e) {
        console.error(e);
      }
    }

    function onShelterChange() {
      const select = document.getElementById('shelterSelect');
      selectedShelterId = select.value;

      if (!selectedShelterId) {
        document.getElementById('shelterInfoCard').style.display = 'none';
        document.getElementById('messageInputArea').style.display = 'none !important';
        return;
      }

      // Show shelter info
      const shelter = sheltersData.find(s => s.id === selectedShelterId);
      if (shelter) {
        document.getElementById('shelterLogo').src = shelter.logo_url || 'https://placehold.co/70x70?text=S';
        document.getElementById('shelterName').textContent = shelter.name;
        document.getElementById('shelterAddress').textContent = shelter.address || 'N/A';
        document.getElementById('shelterPhone').textContent = shelter.phone || 'N/A';
        document.getElementById('shelterEmail').textContent = shelter.email || 'N/A';
        document.getElementById('shelterInfoCard').style.display = 'block';
      }

      // Show input
      document.getElementById('messageInputArea').style.display = 'flex';

      // Load messages
      loadMessages();
    }

    async function loadMessages() {
      const chatBox = document.getElementById('chatBox');
      chatBox.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-success"></div></div>';

      try {
        const res = await fetch(`/api/messages/${currentUser.id}/${selectedShelterId}`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token') || ''}` }
        });

        const data = await res.json();
        const messages = data.messages || [];

        if (messages.length === 0) {
          chatBox.innerHTML = `
            <div class="text-center text-muted py-4">
              <i class="fas fa-comment-dots" style="font-size:2.5rem;opacity:0.3;"></i>
              <p class="mt-2 small">No messages yet. Say hello! üëã</p>
            </div>`;
          return;
        }

        chatBox.innerHTML = '';
        messages.forEach(msg => {
          const isSent = msg.sender_id === currentUser.id;
          const time = new Date(msg.sent_at).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
          chatBox.innerHTML += `
            <div class="d-flex mb-2">
              <div class="message-bubble ${isSent ? 'message-sent' : 'message-received'}">
                <p class="mb-0">${msg.content}</p>
                <small class="opacity-75" style="font-size:10px;">${time}</small>
              </div>
            </div>`;
        });

        // Scroll to bottom
        chatBox.scrollTop = chatBox.scrollHeight;

      } catch (e) {
        chatBox.innerHTML = '<div class="alert alert-danger">Error loading messages.</div>';
      }
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const content = input.value.trim();

      if (!content) return;
      if (!selectedShelterId) {
        document.getElementById('messageResult').innerHTML =
          '<div class="alert alert-warning small py-2">Please select a shelter first.</div>';
        return;
      }

      input.disabled = true;

      try {
        const res = await fetch('/api/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
          },
          body: JSON.stringify({
            sender_id: currentUser.id,
            receiver_id: selectedShelterId,
            content: content,
            is_read: false
          })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to send');

        input.value = '';
        document.getElementById('messageResult').innerHTML = '';
        loadMessages(); // Refresh chat

      } catch (err) {
        document.getElementById('messageResult').innerHTML =
          `<div class="alert alert-danger small py-2">${err.message}</div>`;
      } finally {
        input.disabled = false;
        input.focus();
      }
    }

    function handleEnter(event) {
      if (event.key === 'Enter') sendMessage();
    }
  </script>
</body>
</html>